<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>QuickBite | Cart</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="src/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        /* --- Animation for Removing Items --- */
        @keyframes slideOutRight {
            0% { 
                transform: translateX(0); 
                opacity: 1; 
                max-height: 100px; /* Approximate height of card */
                margin-bottom: 10px;
            }
            100% { 
                transform: translateX(100%); 
                opacity: 0; 
                max-height: 0;
                margin-bottom: 0;
                padding: 0;
                border: none;
            }
        }

        .slide-out {
            animation: slideOutRight 0.5s cubic-bezier(0.55, -0.04, 0.91, 0.94) forwards;
            overflow: hidden; /* Important for collapsing height */
        }

        /* --- Remove Button Style --- */
        .btn-remove {
            background: #fee2e2;
            color: #ef4444;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
            margin-left: 15px;
        }

        .btn-remove:hover {
            background: #ef4444;
            color: white;
            transform: scale(1.1);
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo-section">
                <img src="src/logo.png" style="width: 45px; border-radius: 50px;" alt="">
                <h2>QuickBite</h2>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-link"><i class="fa-solid fa-house"></i> <span>Home</span></a>
                <a href="category.html" class="nav-link"><i class="fa-solid fa-utensils"></i> <span>Menu</span></a>
                <a href="cart.html" class="nav-link active"><i class="fa-solid fa-cart-shopping"></i> <span>Cart</span></a>
                <a href="order-status.html" class="nav-link"><i class="fa fa-clock"></i> Orders</a>
                <a href="account_info.html" class="nav-link"><i class="fa-solid fa-user"></i> <span>Profile</span></a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <h1>Your Cart</h1>
            </header>

            <div id="cartView">
                <div id="cartItemsContainer" style="margin-bottom: 30px;">
                    </div>

                <div class="summary-card" style="background:white; padding:20px; border-radius:15px; width: 300px;">
                    <h3>Total: <span id="cartTotal">₹0</span></h3>
                    <button id="checkoutBtn" class="btn-primary" onclick="placeOrder()"
                        style="width:100%; background:#FF6B6B; color:white; border:none; padding:12px; margin-top:20px; border-radius:10px; cursor:pointer; font-size:1.1rem;">
                        Place Order
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script src="script.js"></script>

    <script>
        // 1. Load Cart on Page Load
        window.onload = function () {
            renderCart();
        };

        // 2. Render Function (Reusable)
        function renderCart() {
            const cart = JSON.parse(localStorage.getItem('quickbite_cart'));
            const container = document.getElementById('cartItemsContainer');
            const totalEl = document.getElementById('cartTotal');

            if (!cart || !cart.items || cart.items.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding: 40px; color:#888;">
                        <i class="fa-solid fa-cart-arrow-down" style="font-size: 3rem; margin-bottom:15px; opacity:0.5;"></i>
                        <p>Cart is empty.</p>
                        <a href="category.html" class="btn-primary" style="display:inline-block; margin-top:10px; font-size:0.9rem;">Browse Menu</a>
                    </div>`;
                totalEl.innerText = "₹0";
                return;
            }

            totalEl.innerText = "₹" + cart.total;
            container.innerHTML = "";

            cart.items.forEach(item => {
                container.innerHTML += `
                    <div class="cart-item" id="item-${item.name.replace(/\s+/g, '-')}" style="display:flex; align-items:center; background:white; padding:15px; margin-bottom:10px; border-radius:16px;">
                        
                        <img src="${item.image}" width="70" height="70" style="border-radius:12px; margin-right:15px; object-fit:cover;">
                        
                        <div style="flex:1;">
                            <h4 style="margin-bottom:4px;">${item.name}</h4>
                            <p style="color:gray; font-size:0.9rem;">₹${item.price} x ${item.quantity}</p>
                        </div>
                        
                        <div style="font-weight:bold; font-size:1.1rem; margin-right:10px;">₹${item.price * item.quantity}</div>
                        
                        <button class="btn-remove" onclick="deleteItem('${item.name}', this)">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
            });
        }

        // 3. Delete Item with Animation
        function deleteItem(name, btnElement) {
            // A. Find the specific row
            const row = btnElement.closest('.cart-item');

            // B. Add the animation class
            row.classList.add('slide-out');

            // C. Wait for animation (500ms) then remove data
            setTimeout(() => {
                let cart = JSON.parse(localStorage.getItem('quickbite_cart'));
                
                // Filter out the item completely
                cart.items = cart.items.filter(item => item.name !== name);
                
                // Recalculate Total
                cart.total = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                // Save and Re-render
                localStorage.setItem('quickbite_cart', JSON.stringify(cart));
                
                // We remove the element from DOM immediately to avoid full re-render flickering
                row.remove(); 
                
                // Update text
                document.getElementById('cartTotal').innerText = "₹" + cart.total;

                // If empty, show empty state
                if(cart.items.length === 0) renderCart();

            }, 500); // Matches CSS animation duration
        }

        // 4. Send Order to Firebase
        function placeOrder() {
            const user = firebase.auth().currentUser;
            if (!user) {
                showNotification('error', 'Access Denied', 'Please login to place an order.', 'login-signup.html');
                return;
            }

            const cart = JSON.parse(localStorage.getItem('quickbite_cart'));

            if (!cart || cart.items.length === 0) {
                showNotification('error', 'Cart Empty', 'Add some delicious food first!');
                return;
            }

            // Check Wallet Logic (If implemented)
            // ...

            showNotification('loading', 'Processing', 'Placing your order...');

            const orderData = {
                userId: user.uid,
                userEmail: user.email,
                items: cart.items,
                total: cart.total,
                status: "Pending",
                timestamp: Date.now(),
                queueNumber: Math.floor(Math.random() * 50) + 1
            };

            db.ref('orders').push(orderData)
                .then(() => {
                    localStorage.removeItem('quickbite_cart');
                    showNotification('success', 'Order Placed!', 'Your order ID has been generated.', 'order-status.html');
                })
                .catch(err => {
                    showNotification('error', 'Order Failed', err.message);
                });
        }
    </script>
</body>
</html>
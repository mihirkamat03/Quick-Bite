<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>QuickBite | Track Order</title>
    <link rel="icon" href="src/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        /* --- TRACKER SPECIFIC STYLES --- */
        .status-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
            margin-top: 20px;
        }

        /* Animated Pulse Ring */
        .status-icon-wrapper {
            width: 80px;
            height: 80px;
            background: #e0e7ff;
            color: #4f46e5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 20px;
            position: relative;
        }

        /* Dynamic Colors based on State */
        .state-Pending .status-icon-wrapper {
            background: #fffbeb;
            color: #d97706;
        }

        .state-Preparing .status-icon-wrapper {
            background: #eff6ff;
            color: #2563eb;
            animation: pulse-blue 2s infinite;
        }

        .state-Ready .status-icon-wrapper {
            background: #ecfdf5;
            color: #059669;
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-blue {
            0% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4);
            }

            70% {
                box-shadow: 0 0 0 20px rgba(37, 99, 235, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
            }
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.4);
            }

            70% {
                box-shadow: 0 0 0 20px rgba(5, 150, 105, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(5, 150, 105, 0);
            }
        }

        /* Progress Steps */
        .progress-track {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            position: relative;
        }

        .progress-track::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            z-index: 1;
        }

        .step {
            position: relative;
            z-index: 2;
            background: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 4px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #9ca3af;
            transition: 0.4s;
        }

        .step.active {
            border-color: #10b981;
            background: #10b981;
            color: white;
        }

        .step-label {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 600;
            white-space: nowrap;
        }

        .order-meta {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed #ccc;
            text-align: left;
        }
    </style>
</head>

<body class="status-page">
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo-section">
                <img src="src/logo.png" style="width: 45px; border-radius: 50px;" alt="">
                <h2>QuickBite</h2>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-link"><i class="fa-solid fa-house"></i> <span>Home</span></a>
                <a href="category.html" class="nav-link"><i class="fa-solid fa-utensils"></i> <span>Menu</span></a>
                <a href="cart.html" class="nav-link"><i class="fa-solid fa-cart-shopping"></i> <span>Cart</span></a>
                <a href="order-status.html" class="nav-link active"><i class="fa fa-clock"></i> Orders</a>
                <a href="account_info.html" class="nav-link"><i class="fa-solid fa-user"></i> <span>Profile</span></a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <h1>Track Order</h1>
            </header>

            <div id="trackerContainer" class="status-container" style="display:none;">

                <div id="statusIcon" class="status-icon-wrapper">
                    <i class="fa-solid fa-hourglass-start"></i>
                </div>

                <h2 id="statusText">Order Placed</h2>
                <p style="color:gray;">Queue Number: <span id="queueNum"
                        style="color:#333; font-weight:bold;">#--</span></p>

                <div class="progress-track">
                    <div class="step active" id="step1"><i class="fa-solid fa-check"></i> <span
                            class="step-label">Sent</span></div>
                    <div class="step" id="step2"><i class="fa-solid fa-fire-burner"></i> <span
                            class="step-label">Cooking</span></div>
                    <div class="step" id="step3"><i class="fa-solid fa-bell-concierge"></i> <span
                            class="step-label">Ready</span></div>
                </div>

                <div class="order-meta">
                    <h4>Items:</h4>
                    <ul id="itemList" style="list-style:none; padding:0; margin-top:10px; color:#555;">
                    </ul>
                    <h3 style="margin-top:15px; text-align:right;">Total: <span id="totalPrice"
                            style="color:#FF6B6B;">₹0</span></h3>
                </div>

            </div>

            <div id="noOrderState" style="text-align:center; margin-top:50px; display:none;">
                <img src="https://cdn-icons-png.flaticon.com/512/2038/2038854.png" width="150" style="opacity:0.5;">
                <h3 style="color:#888; margin-top:20px;">No Active Orders</h3>
                <a href="category.html" class="btn-primary" style="margin-top:15px; display:inline-block;">Order Now</a>
            </div>

        </main>
    </div>

    <script src="script.js"></script>

    <script>

        const soundReady = new Audio('src/ready.wav');
        
        let lastStatus = "";

        // --- 2. AUTH CHECK ---
        if (auth) {
            auth.onAuthStateChanged(user => {
                if (user) {
                    loadActiveOrder(user.uid);
                } else {
                    window.location.href = 'login-signup.html';
                }
            });
        }

        // --- 3. MAIN LOGIC ---
        function loadActiveOrder(uid) {
            const ordersRef = db.ref('orders').orderByChild('userId').equalTo(uid).limitToLast(1);

            ordersRef.on('value', snapshot => {
                const data = snapshot.val();

                if (!data) {
                    showEmptyState();
                    return;
                }

                const orderId = Object.keys(data)[0];
                const order = data[orderId];

                if (order.status === 'Delivered' || order.status === 'Cancelled') {
                    showEmptyState();
                    return;
                }

                // --- SOUND LOGIC START ---
                // We check if the status has CHANGED from what we last saw
                if (order.status !== lastStatus) {

                    // If moving to Ready -> Play Ding Sound
                    if (order.status === 'Ready') {
                        soundReady.play().catch(e => console.log("Audio blocked:", e));
                    }

                    // Update our tracker
                    lastStatus = order.status;
                }
                // --- SOUND LOGIC END ---

                // RENDER UI
                document.getElementById('noOrderState').style.display = 'none';
                document.getElementById('trackerContainer').style.display = 'block';
                document.getElementById('trackerContainer').className = `status-container state-${order.status}`;

                document.getElementById('queueNum').innerText = "#" + (order.queueNumber || '00');
                document.getElementById('totalPrice').innerText = "₹" + order.total;

                const list = document.getElementById('itemList');
                list.innerHTML = '';
                if (order.items) {
                    order.items.forEach(item => {
                        list.innerHTML += `
                            <li style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <span>${item.name} <small>x${item.quantity}</small></span>
                                <span>₹${item.price * item.quantity}</span>
                            </li>`;
                    });
                }

                updateProgressUI(order.status);
            });
        }

        function showEmptyState() {
            document.getElementById('noOrderState').style.display = 'block';
            document.getElementById('trackerContainer').style.display = 'none';
        }

        function updateProgressUI(status) {
            const steps = [document.getElementById('step1'), document.getElementById('step2'), document.getElementById('step3')];
            const title = document.getElementById('statusText');
            const iconWrapper = document.getElementById('statusIcon');
            const icon = iconWrapper.querySelector('i');

            steps.forEach(s => s.classList.remove('active'));

            if (status === 'Pending') {
                steps[0].classList.add('active');
                title.innerText = "Order Sent to Kitchen";
                icon.className = "fa-solid fa-hourglass-start";
            }
            else if (status === 'Preparing') {
                steps[0].classList.add('active');
                steps[1].classList.add('active');
                title.innerText = "Chef is Cooking...";
                icon.className = "fa-solid fa-fire-burner";
            }
            else if (status === 'Ready') {
                steps[0].classList.add('active');
                steps[1].classList.add('active');
                steps[2].classList.add('active');
                title.innerText = "Order Ready for Pickup!";
                icon.className = "fa-solid fa-bell-concierge";
            }
        }
    </script>
</body>

</html>
</body>

</html>